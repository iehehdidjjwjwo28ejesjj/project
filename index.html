<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d1117">
    <title>SyncCode Mobile</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/mode-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/mode-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/mode-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/theme-monokai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ext-language_tools.min.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        html, body { height: 100%; overflow: hidden; position: fixed; width: 100%; touch-action: pan-x pan-y; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117; 
            color: #c9d1d9; 
            display: flex;
            flex-direction: column;
        }
        
        .toolbar { 
            height: 60px; 
            background: #161b22; 
            border-bottom: 1px solid #30363d;
            display: flex; 
            align-items: center; 
            padding: 0 12px; 
            gap: 8px;
            flex-shrink: 0;
        }
        
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button { 
            background: #21262d; 
            border: 1px solid #30363d; 
            color: #f0f6fc; 
            border-radius: 8px; 
            height: 44px; 
            min-width: 44px;
            padding: 0 12px; 
            font-size: 16px;
            cursor: pointer;
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: 6px;
            touch-action: manipulation;
        }
        
        button:active { transform: scale(0.95); background: #30363d; }
        .btn-primary { background: #238636; border-color: #238636; }
        .btn-stop { background: #da3633; border-color: #da3633; }
        .btn-yellow { background: #d29922; border-color: #d29922; color: black; }
        .btn-yellow.active { background: #e3b341; }
        .btn-icon { padding: 0; width: 44px; }
        
        .status {
            font-size: 13px;
            color: #8b949e;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 10px;
            background: #21262d;
            border-radius: 8px;
            height: 44px;
            border: 1px solid #30363d;
        }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #666; }
        .status-dot.online { background: #3fb950; box-shadow: 0 0 8px #3fb950; }
        .status-dot.offline { background: #da3633; }
        .status-dot.connecting { background: #d29922; animation: blink 1s infinite; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        
        .dropdown { position: relative; min-width: 140px; }
        .dropdown-trigger { 
            width: 100%; background: #21262d; border: 1px solid #30363d; color: #f0f6fc; 
            border-radius: 8px; height: 44px; padding: 0 10px; 
            display: flex; align-items: center; justify-content: space-between; 
            cursor: pointer; font-size: 14px; gap: 8px;
        }
        .dropdown-trigger > div { display: flex; align-items: center; gap: 8px; }
        .dropdown-menu { 
            position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; 
            background: #161b22; border: 1px solid #30363d; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; z-index: 1000;
            overflow: hidden;
        }
        .dropdown-menu.open { display: block; }
        .dropdown-item { 
            padding: 10px 12px; cursor: pointer; display: flex; align-items: center; 
            gap: 8px; font-size: 13px; border-bottom: 1px solid #30363d; 
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #21262d; }
        .dropdown-item.active { background: #238636; color: white; }
        
        .file-icon {
            width: 20px; height: 20px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold; flex-shrink: 0;
        }
        .html-icon { background: #e34c26; color: white; }
        .css-icon { background: #264de4; color: white; }
        .js-icon { background: #f7df1e; color: black; }
        
        .editor-container { flex: 1; position: relative; overflow: hidden; }
        .editor-pane { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; }
        .editor-pane.active { display: block; }
        .ace_editor { font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace !important; position: relative; }
        
        .remote-cursor {
            position: absolute; width: 2px; height: 20px;
            pointer-events: none; z-index: 50; transition: all 0.1s ease-out;
        }
        .remote-caret { width: 100%; height: 100%; animation: blink 1s infinite; }
        .cursor-label {
            position: absolute; top: -22px; left: 0; padding: 2px 8px; border-radius: 4px;
            font-size: 12px; font-weight: bold; color: black; white-space: nowrap;
        }
        
        .preview-overlay { 
            position: fixed; top: 60px; left: 0; right: 0; bottom: 0; 
            background: white; z-index: 90; display: none; flex-direction: column; 
        }
        .preview-overlay.active { display: flex; }
        iframe { flex: 1; border: none; width: 100%; background: white; }
        
        .console-wrapper { 
            position: fixed; left: 0; right: 0; bottom: 0; height: 0; 
            background: #161b22; border-top: 2px solid #30363d; 
            display: flex; flex-direction: column; z-index: 95; 
            transition: height 0.25s ease-out;
        }
        .console-wrapper.open { height: 40vh; min-height: 200px; max-height: 70vh; }
        
        .console-resize { 
            height: 24px; background: #21262d; cursor: row-resize; 
            display: flex; align-items: center; justify-content: center; 
            border-bottom: 1px solid #30363d; touch-action: none;
        }
        .console-resize:active { background: #30363d; }
        .console-resize::after { content: '━━━'; color: #484f58; font-size: 14px; letter-spacing: 2px; }
        
        .console-header { 
            height: 44px; background: #21262d; display: flex; align-items: center; 
            padding: 0 12px; font-size: 14px; color: #8b949e; 
            border-bottom: 1px solid #30363d; justify-content: space-between; flex-shrink: 0;
        }
        .console-body { 
            flex: 1; overflow-y: auto; padding: 10px; 
            font-family: monospace; font-size: 14px; line-height: 1.5;
            -webkit-overflow-scrolling: touch;
        }
        .console-line { padding: 4px 0; display: flex; gap: 8px; border-bottom: 1px solid #21262d; word-break: break-word; }
        .console-log { color: #c9d1d9; }
        .console-error { color: #f85149; }
        .console-time { color: #6e7681; flex-shrink: 0; font-size: 12px; }
        .console-input-line { 
            display: flex; gap: 10px; padding: 10px 12px; 
            border-top: 2px solid #30363d; background: #0d1117; flex-shrink: 0;
        }
        .console-prompt { color: #3fb950; font-weight: bold; font-size: 16px; }
        .console-input { 
            background: transparent; border: none; color: #c9d1d9; 
            font-family: monospace; font-size: 15px; flex: 1; outline: none;
        }
        .empty-state { text-align: center; color: #484f58; padding: 20px; }
        
        .name-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 2000; display: flex;
            align-items: center; justify-content: center;
        }
        .name-modal-content {
            background: #161b22; border: 1px solid #30363d; border-radius: 12px;
            padding: 24px; width: 90%; max-width: 400px;
        }
        .name-modal-title {
            font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #f0f6fc;
        }
        .name-modal-input {
            width: 100%; background: #0d1117; border: 1px solid #30363d;
            color: #c9d1d9; padding: 12px; border-radius: 8px; font-size: 16px;
            margin-bottom: 16px; outline: none;
        }
        .name-modal-input:focus { border-color: #238636; }
        .name-modal-buttons {
            display: flex; gap: 8px; justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div id="nameModal" class="name-modal" style="display: none;">
        <div class="name-modal-content">
            <div class="name-modal-title">Введите ваше имя</div>
            <input type="text" class="name-modal-input" id="nameInput" placeholder="Ваше имя..." maxlength="20">
            <div class="name-modal-buttons">
                <button onclick="saveName()">Сохранить</button>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <div class="toolbar-left">
            <div class="dropdown">
                <div class="dropdown-trigger" onclick="toggleDropdown()">
                    <div>
                        <span class="file-icon html-icon" id="currentIcon">H</span>
                        <span id="currentFile">index.html</span>
                    </div>
                    <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                </div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-item active" onclick="switchFile('html')">
                        <span class="file-icon html-icon">H</span>
                        <span>index.html</span>
                    </div>
                    <div class="dropdown-item" onclick="switchFile('css')">
                        <span class="file-icon css-icon">C</span>
                        <span>style.css</span>
                    </div>
                    <div class="dropdown-item" onclick="switchFile('js')">
                        <span class="file-icon js-icon">J</span>
                        <span>script.js</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toolbar-right">
            <button class="btn-primary" id="runBtn" onclick="toggleRun()">
                <i data-lucide="play" id="runIcon"></i>
            </button>
            
            <button class="btn-yellow" id="consoleBtn" onclick="toggleConsole()">
                <i data-lucide="terminal" id="consoleIcon"></i>
            </button>
            
            <div class="status">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="userCount">1</span>
            </div>
        </div>
    </div>
    
    <div class="editor-container">
        <div class="editor-pane active" id="pane-html"><div id="editor-html" style="width:100%;height:100%"></div></div>
        <div class="editor-pane" id="pane-css"><div id="editor-css" style="width:100%;height:100%"></div></div>
        <div class="editor-pane" id="pane-js"><div id="editor-js" style="width:100%;height:100%"></div></div>
    </div>
    
    <div class="preview-overlay" id="previewOverlay">
        <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
    
    <div class="console-wrapper" id="consoleWrapper">
        <div class="console-resize" ontouchstart="startResizeTouch(event)" onmousedown="startResizeMouse(event)"></div>
        <div class="console-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i data-lucide="terminal" style="width: 18px; height: 18px;"></i>
                <span style="font-weight: 600;">Console</span>
                <span style="color: #6e7681; font-size: 12px;" id="logCount">0</span>
            </div>
            <button onclick="clearConsole()" style="padding: 8px; height: 36px; width: 36px;">
                <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
            </button>
        </div>
        <div class="console-body" id="consoleBody">
            <div class="empty-state">Нажмите Run...</div>
        </div>
        <div class="console-input-line">
            <span class="console-prompt">❯</span>
            <input type="text" class="console-input" id="consoleInput" placeholder="Код..." onkeydown="handleConsole(event)">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7kKg6LbtJ51sw9US2AyRmkI_NwDmE28Q",
            authDomain: "project-vigenersl.firebaseapp.com",
            databaseURL: "https://project-vigenersl-default-rtdb.firebaseio.com",
            projectId: "project-vigenersl",
            storageBucket: "project-vigenersl.firebasestorage.app",
            messagingSenderId: "710338575654",
            appId: "1:710338575654:web:e7ba2076dc5bd160da55e7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const defaultFiles = {
            html: `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Hello Mobile</h1>
    <button id="btn">Tap me</button>
    <script src="script.js"><\\/script>
</body>
</html>`,
            css: `body { 
    font-family: -apple-system; 
    background: #f0f0f0; 
    text-align: center; 
    padding: 20px; 
    touch-action: manipulation;
}
h1 { color: #333; font-size: 24px; }
button { padding: 15px 30px; font-size: 18px; margin: 10px; touch-action: manipulation; }`,
            js: `const btn = document.getElementById('btn');
let count = 0;
btn.addEventListener('click', () => {
    count++;
    console.log('Tap #' + count);
    btn.textContent = 'Taps: ' + count;
});`
        };

        window.db = db;
        window.defaultFiles = defaultFiles;
        window.serverTimestamp = serverTimestamp;
        window.ref = ref;
        window.get = get;
        window.set = set;
        window.onValue = onValue;
        window.onDisconnect = onDisconnect;
    </script>

    <script>
        let editors = {}, userId = null, remoteUsers = new Map();
        let isRunning = false, isConsoleOpen = false, currentFile = 'html';
        let fontSize = 16, userName = '';
        let fileUpdateTimeout = null;

        window.onload = () => {
            checkUserName();
            initEditors();
            lucide.createIcons();
            setupPinchZoom();
        };

        function checkUserName() {
            const savedName = localStorage.getItem('syncCodeUserName');
            if (savedName) {
                userName = savedName;
                setupFirebase();
            } else {
                document.getElementById('nameModal').style.display = 'flex';
                document.getElementById('nameInput').focus();
            }
        }

        function saveName() {
            const name = document.getElementById('nameInput').value.trim();
            if (name) {
                userName = name;
                localStorage.setItem('syncCodeUserName', name);
                document.getElementById('nameModal').style.display = 'none';
                setupFirebase();
            }
        }

        function initEditors() {
            ['html', 'css', 'js'].forEach(type => {
                editors[type] = ace.edit('editor-' + type);
                editors[type].setTheme('ace/theme/monokai');
                editors[type].session.setMode('ace/mode/' + (type === 'js' ? 'javascript' : type));
                editors[type].setOptions({
                    fontSize: fontSize, showPrintMargin: false,
                    enableBasicAutocompletion: true, enableLiveAutocompletion: true,
                    tabSize: 2, useSoftTabs: true, showFoldWidgets: false,
                    wrap: true, useWrapMode: true
                });
                editors[type].setValue(window.defaultFiles[type], -1);
                
                editors[type].on('change', () => {
                    clearTimeout(fileUpdateTimeout);
                    fileUpdateTimeout = setTimeout(() => {
                        sendFileChange(currentFile, editors[currentFile].getValue());
                        if (isRunning) updatePreview();
                    }, 300);
                });
            });
            
            setInterval(() => {
                if (userId) {
                    const pos = editors[currentFile].selection.getCursor();
                    sendCursor(currentFile, pos.row, pos.column);
                }
            }, 100);
        }

        function setupFirebase() {
            updateStatus('connecting');
            
            userId = localStorage.getItem('firebaseUserId') || 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('firebaseUserId', userId);
            
            const userColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            
            const userRef = window.ref(window.db, 'users/' + userId);
            const filesRef = window.ref(window.db, 'files');
            const usersRef = window.ref(window.db, 'users');
            
            window.onDisconnect(userRef).remove();
            window.set(userRef, { name: userName, color: userColor, cursor: { file: 'html', row: 0, column: 0 } });
            
            window.get(filesRef).then(snapshot => {
                if (snapshot.exists()) {
                    const files = snapshot.val();
                    ['html','css','js'].forEach(f => {
                        if (files[f] && editors[f].getValue() !== files[f]) {
                            const pos = editors[f].selection.getCursor();
                            editors[f].setValue(files[f], -1);
                            editors[f].selection.moveTo(pos.row, pos.column);
                        }
                    });
                }
                updateStatus('online');
            }).catch(() => updateStatus('offline'));
            
            window.onValue(filesRef, snapshot => {
                if (!snapshot.exists()) return;
                const files = snapshot.val();
                ['html','css','js'].forEach(f => {
                    if (files[f] && editors[f].getValue() !== files[f]) {
                        const pos = editors[f].selection.getCursor();
                        editors[f].setValue(files[f], -1);
                        editors[f].selection.moveTo(pos.row, pos.column);
                    }
                });
            });
            
            window.onValue(usersRef, snapshot => {
                if (!snapshot.exists()) {
                    updateCount(0);
                    return;
                }
                const users = snapshot.val();
                const userIds = Object.keys(users);
                updateCount(userIds.length - 1);
                
                Object.entries(users).forEach(([id, data]) => {
                    if (id !== userId && data.cursor) {
                        showRemoteCursor(id, data.name || 'User', data.cursor.file, data.cursor.row, data.cursor.column, data.color);
                        remoteUsers.set(id, data);
                    } else if (id !== userId) {
                        removeRemoteCursor(id);
                        remoteUsers.delete(id);
                    }
                });
                
                remoteUsers.forEach((_, id) => {
                    if (!users[id]) {
                        removeRemoteCursor(id);
                        remoteUsers.delete(id);
                    }
                });
            });
        }

        function sendFileChange(file, content) {
            if (!userId) return;
            window.set(window.ref(window.db, 'files/' + file), content);
        }

        function sendCursor(file, row, column) {
            if (!userId) return;
            window.set(window.ref(window.db, 'users/' + userId + '/cursor'), { file, row, column, timestamp: window.serverTimestamp() });
        }

        function removeUser() {
            if (!userId) return;
            window.set(window.ref(window.db, 'users/' + userId), null);
        }

        function updateStatus(status) { 
            document.getElementById('statusDot').className = 'status-dot ' + status; 
        }
        
        function updateCount(count) { 
            document.getElementById('userCount').textContent = count + 1; 
        }
        
        function showRemoteCursor(uid, name, file, row, col, color) {
            if (file !== currentFile) return;
            const old = document.getElementById('cursor-' + uid); 
            if (old) old.remove();
            const editor = editors[file];
            const session = editor.session;
            const pos = session.documentToScreenPosition(row, col);
            const pixelPos = editor.renderer.textToPixelCoordinates(pos.row, pos.column);
            const el = document.createElement('div');
            el.id = 'cursor-' + uid; 
            el.className = 'remote-cursor';
            
            if (pixelPos) {
                el.style.left = pixelPos.left + 'px'; 
                el.style.top = pixelPos.top + 'px';
            }
            
            el.innerHTML = `<div class="remote-caret" style="background:${color};"></div><div class="cursor-label" style="background:${color};">${name}</div>`;
            editor.container.appendChild(el);
        }
        
        function removeRemoteCursor(uid) { 
            const el = document.getElementById('cursor-' + uid); 
            if (el) el.remove(); 
        }

        function switchFile(type) {
            currentFile = type;
            document.querySelectorAll('.editor-pane').forEach(p => p.classList.remove('active'));
            document.getElementById('pane-' + type).classList.add('active');
            document.querySelectorAll('.dropdown-item').forEach((el, i) => el.classList.toggle('active', ['html','css','js'][i] === type));
            
            const names = {html: 'index.html', css: 'style.css', js: 'script.js'};
            const icons = {html: 'H', css: 'C', js: 'J'};
            const colors = {html: 'html-icon', css: 'css-icon', js: 'js-icon'};
            document.getElementById('currentFile').textContent = names[type];
            const iconEl = document.getElementById('currentIcon');
            iconEl.textContent = icons[type]; 
            iconEl.className = 'file-icon ' + colors[type];
            document.getElementById('dropdownMenu').classList.remove('open');
            setTimeout(() => editors[type].resize(), 50);
        }

        function toggleDropdown() { 
            document.getElementById('dropdownMenu').classList.toggle('open'); 
        }
        
        document.addEventListener('click', (e) => { 
            if (!e.target.closest('.dropdown')) document.getElementById('dropdownMenu').classList.remove('open'); 
        });

        function toggleRun() {
            isRunning = !isRunning;
            const btn = document.getElementById('runBtn'), icon = document.getElementById('runIcon'), overlay = document.getElementById('previewOverlay');
            if (isRunning) { 
                btn.className = 'btn-stop'; 
                icon.setAttribute('data-lucide', 'square'); 
                overlay.classList.add('active'); 
                updatePreview(); 
            } else { 
                btn.className = 'btn-primary'; 
                icon.setAttribute('data-lucide', 'play'); 
                overlay.classList.remove('active');
                closeConsole(); 
            }
            lucide.createIcons();
        }

        function updatePreview() {
            clearConsole();
            const doc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>${editors.css.getValue()}</style></head><body>${editors.html.getValue()}<script>
console.log = (...a) => parent.postMessage({t:'log',d:a.join(' ')},'*');
console.error = (...a) => parent.postMessage({t:'err',d:a.join(' ')},'*');
window.onerror = (m,u,l) => { parent.postMessage({t:'err',d:m+' (line '+l+')'},'*'); return true; };
try { ${editors.js.getValue()} } catch(e) { console.error(e.message); }
<\/script></body></html>`;
            document.getElementById('previewFrame').srcdoc = doc;
            
            if (!isConsoleOpen) {
                openConsole();
            }
        }

        function openConsole() {
            isConsoleOpen = true;
            document.getElementById('consoleWrapper').classList.add('open');
            document.getElementById('consoleBtn').classList.add('active');
            document.getElementById('consoleIcon').setAttribute('data-lucide', 'x');
            lucide.createIcons();
        }

        function closeConsole() {
            isConsoleOpen = false;
            document.getElementById('consoleWrapper').classList.remove('open');
            document.getElementById('consoleBtn').classList.remove('active');
            document.getElementById('consoleIcon').setAttribute('data-lucide', 'terminal');
            document.getElementById('consoleWrapper').style.height = '';
            lucide.createIcons();
        }

        function toggleConsole() {
            if (isConsoleOpen) {
                closeConsole();
            } else {
                openConsole();
            }
        }

        function startResizeMouse(e) {
            let startY = e.clientY, startH = document.getElementById('consoleWrapper').offsetHeight;
            function move(e) { 
                const newH = Math.max(150, Math.min(window.innerHeight - 100, startH + (startY - e.clientY))); 
                document.getElementById('consoleWrapper').style.height = newH + 'px'; 
            }
            function up() { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); }
            document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
        }

        function startResizeTouch(e) {
            e.preventDefault();
            let startY = e.touches[0].clientY, startH = document.getElementById('consoleWrapper').offsetHeight;
            function move(e) { 
                const newH = Math.max(150, Math.min(window.innerHeight - 100, startH + (startY - e.touches[0].clientY))); 
                document.getElementById('consoleWrapper').style.height = newH + 'px'; 
            }
            function up() { document.removeEventListener('touchmove', move); document.removeEventListener('touchend', up); }
            document.addEventListener('touchmove', move, {passive: false}); document.addEventListener('touchend', up);
        }

        function clearConsole() { 
            document.getElementById('consoleBody').innerHTML = '<div class="empty-state">Очищено</div>'; 
            document.getElementById('logCount').textContent = '0'; 
        }
        
        function handleConsole(e) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                addLog('> ' + e.target.value, 'info');
                try { 
                    const result = document.getElementById('previewFrame').contentWindow.eval(e.target.value); 
                    if (result !== undefined) addLog(String(result), 'log'); 
                } catch(err) { 
                    addLog(err.message, 'error'); 
                }
                e.target.value = '';
            }
        }
        
        function addLog(msg, type) {
            const body = document.getElementById('consoleBody');
            if (body.children[0]?.classList.contains('empty-state')) body.innerHTML = '';
            const div = document.createElement('div'); 
            div.className = 'console-line'; 
            div.innerHTML = `<span class="console-time">${new Date().toLocaleTimeString('ru-RU',{hour12:false})}</span><span class="console-${type}">${msg}</span>`;
            body.appendChild(div); 
            body.scrollTop = body.scrollHeight; 
            document.getElementById('logCount').textContent = body.children.length;
        }
        
        window.addEventListener('message', (e) => { 
            if (e.data?.t) addLog(e.data.d, e.data.t); 
        });

        function setupPinchZoom() {
            let initialDist = 0, initialSize = 16, isPinching = false;
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    isPinching = true;
                    initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    initialSize = fontSize;
                }
            }, {passive: false});
            document.addEventListener('touchmove', (e) => {
                if (!isPinching || e.touches.length !== 2) return;
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                fontSize = Math.max(10, Math.min(28, Math.round(initialSize * (dist / initialDist))));
                Object.values(editors).forEach(ed => ed.setFontSize(fontSize));
            }, {passive: false});
            document.addEventListener('touchend', () => { isPinching = false; });
        }
        
        window.addEventListener('beforeunload', () => {
            removeUser();
        });
    </script>
</body>
</html>
